//
//  OrderVC.swift
//  YogiYoCloneIOS
//
//  Created by Qussk_MAC on 2020/09/15.
//  Copyright ¬© 2020 ÍπÄÎèôÌòÑ. All rights reserved.
//

import UIKit


class OderVC : UIViewController {
  
  var orderMager = OrderManager.shared
  var orderList: [OrderData] = []
  
  lazy var leftButton = UIBarButtonItem(barButtonSystemItem: .close, target: self, action: #selector(didTapButton))
  
  public var id : Int = 1
  let tableView2 = UITableView()
  let pikerView = UIPickerView()
  var toolBar = UIToolbar()
  var userString = "ÏöîÏ≤≠ÏÇ¨Ìï≠ÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî."
  let pikerList = ["ÏöîÏ≤≠ÏÇ¨Ìï≠ÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.","Îã®Î¨¥ÏßÄ/ÏπòÌÇ®Î¨¥/Î∞òÏ∞¨Î•ò Ïïà Ï£ºÏÖîÎèÑ ÎèºÏöî.","Î≤®ÏùÄ ÎàÑÎ•¥ÏßÄ ÎßêÏïÑ Ï£ºÏÑ∏Ïöî!","ÎèÑÏ∞© ÌõÑ Ï†ÑÌôîÏ£ºÏãúÎ©¥ ÏßÅÏ†ë Î∞õÏúºÎü¨ Í∞àÍ≤åÏöî.", "Í∑∏ÎÉ• Î¨∏ ÏïûÏóê ÎÜìÏïÑÏ£ºÏãúÎ©¥ ÎèºÏöî.", "ÏßÅÏ†ë ÏûÖÎ†•"]
  var open = false
  
  override func viewDidLoad() {
    super.viewDidLoad()
    orderList = orderMager.showMeOrderedList()
    setTableView2()
    buttonFrame()
    //  navigation()
    title = "Î∞∞Îã¨ Ï£ºÎ¨∏ Í≤∞Ï†ú"
    //   fetchPosts()
    print("orderMager : \(orderMager.showMeOrderedList())")
    addTotal()
    
  }
  
  
  func viewDidappear(_ animated: Bool) {
    buttonFrame()
  }
  override func viewDidLayoutSubviews() {
    buttonFrame()
  }
  
  
  //MARK:- POST
  func onPostShowBible(){
    let parameters: [String: Any] = [
      //      "id" : 4,
      //      "order_menu" : [orderList],
      //      "address" : "ÏÑ±ÏàòÎèô",
      //      "delivery_requests" : "Îã®Î¨¥ÏßÄ",
      //      "paymentMethod" : "payment_method",
      //      "order_time" : "dsdd"
//      "next" : "ee",
//      "previous": "null",
//      "results": [
        "id": 863,
        "order_menu": "Ôºà4Îã§Î¶¨ÔºâÎ∂àÎã≠Î≥∂ÏùåÏπòÌÇ® x 1",
        "restaurant_name": "ÏπòÌÇ®ÎçîÌôà-Í¥ëÏßÑÌôîÏñëÏ†ê",
        "restaurant_image": "https://yogiyo-s3.s3.ap-northeast-2.amazonaws.com/media/restaurant_image/%EC%B9%98%ED%82%A8%EB%8D%94%ED%99%88_20181211_Franchise%EC%9D%B4%EB%AF%B8%EC%A7%80%EC%95%BD%EC%A0%95%EC%84%9C_crop_200x200_JenKKxM.jpg",
        "status": "Ï†ëÏàò ÎåÄÍ∏∞ Ï§ë",
        "order_time": "2020-10-06T14:07:24.043739Z",
        "review_written": false
      ]
    //     "request": [
    //     "address" : "ÏÑ±ÏàòÎèô",
    //     "delivery_requests" : "Îã®Î¨¥ÏßÄ"
    //         ]]
    
    let url = String(format: "http://52.79.251.125/orders")
    guard let serviceUrl = URL(string: url) else { return }
    
    var request = URLRequest(url: serviceUrl)
    request.httpMethod = "POST"
    request.setValue("application/json", forHTTPHeaderField: "Content-Type")
    guard let httpBody = try? JSONSerialization.data(withJSONObject: parameters) else {
      return
    }
    request.httpBody = httpBody
    //   request.timeoutInterval = 20
    let session = URLSession.shared
    session.dataTask(with: request) { (data, response, error) in
      if let response = response {
        print("response" , response)
      }
      if let data = data {
        do {
          let json = try JSONSerialization.jsonObject(with: data, options: [])
          print("json", json)
        } catch {
          print(error)
        }
      }
    }.resume()
  }
  
  let paymentButton : UIButton = {
    let b = UIButton()
    b.backgroundColor = ColorPiker.customMainRed
    b.setTitle("Í≤∞Ï†ú ÌïòÍ∏∞", for: .normal)
    b.setTitleColor(.white, for: .normal)
    b.titleLabel?.font = UIFont(name: FontModel.customRegular, size: 23)
    b.addTarget(self, action: #selector(paymentDidTapButton(_:)), for: .touchUpInside)
    b.isHidden = true
    return b
  }()
  
  //MARK: -Navi
  func navigation(){
    title = "Î∞∞Îã¨ Ï£ºÎ¨∏ Í≤∞Ï†ú"
    navigationItem.leftBarButtonItem = leftButton
    self.navigationController?.navigationBar.setBackgroundImage(UIImage(named: "back"), for: .any, barMetrics: .default)
    navigationController?.navigationBar.backgroundColor = UIColor.white
  }
  
  //MARK:- Action
  //Îí§Î°úÍ∞ÄÍ∏∞
  @objc func didTapButton(_ sender : UIButton){
    navigationController?.popViewController(animated: true)
  }
  //Í≤∞Ï†úÌïòÍ∏∞
  @objc func paymentDidTapButton(_ sender : UIButton){
    onPostShowBible()
    //  onPostShowBible()
    alertController()    
  }
  
  func buttonFrame(){
    paymentButton.frame = CGRect(x: view.frame.minX + 20, y: view.frame.maxY - 20, width: view.frame.width - 40, height: -50)
    //  paymentButton.center = view.center
    view.addSubview(paymentButton)
  }
  
  
  //MARK:- UITableView
  func setTableView2(){
    
    pikerView.delegate = self
    pikerView.dataSource = self
    
    tableView2.dataSource = self
    tableView2.delegate = self
    tableView2.frame = view.frame
    tableView2.rowHeight = UITableView.automaticDimension //ÎèôÏ†ÅÎÜíÏù¥
    tableView2.backgroundColor = .white
    //tableView2.separatorStyle = .none
    tableView2.clipsToBounds = true
    view.addSubview(tableView2)
    
    //CustomOderCell
    tableView2.register(loginCell.self, forCellReuseIdentifier: "loginCell")//0-ÎπÑÌöåÏõê
    tableView2.register(InformationCell.self, forCellReuseIdentifier: "InformationCell")//1-0
    tableView2.register(CustomOrderCell.self, forCellReuseIdentifier: "CustomOrderCell")//1-1
    tableView2.register(PaywithCell.self, forCellReuseIdentifier: "PaywithCell")//2
    tableView2.register(MembershipCell.self, forCellReuseIdentifier: "MembershipCell")//3-ÌöåÏõê
    tableView2.register(unMembershipCell.self, forCellReuseIdentifier: "unMembershipCell")//3-ÎπÑÌöåÏõê
    //OrderListCell
    tableView2.register(OrderListCell.self, forCellReuseIdentifier: "OrderListCell") //Ï£ºÎ¨∏Í≤∞Ï†úÎÇ¥Ïó≠
    tableView2.register(paymentCell.self, forCellReuseIdentifier: "paymentCell")
    
  }
  
  func addTotal() {
    //tableview IndexPathÍ∞íÏóê ÏßÅÏ†ë Ï†ëÍ∑º
    let index = IndexPath(row: 0, section: 4)
    //tableview rowÍ∞íÏóê ÏßÅÏ†ë Ï†ëÍ∑º
    let cellForrow = tableView2.cellForRow(at: index)
    //ÌÉÄÏûÖÏ∫êÏä§ÌåÖÏúºÎ°ú BuyLastTableViewCellÎ∂àÎü¨Ïò§Í∏∞
    let ordercell = cellForrow as? OrderListCell
    ordercell?.totalOrderPriceWon.text = "ÌîåÎ¶¨Ï¶à"
    //"\(3500 + orderList[0].totalPrice!)"
    print("Ï∂úÎ†•Ïù¥ ÎêòÎÇòÏöî?")
    // print(totalPrice())
  }
  
  func alertController(){
    
    let alert = UIAlertController(title: "ÏïåÎ¶º", message: "‚õ≥Ô∏èÏ£ºÎ¨∏Ïù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§~!üèáüö£‚Äç‚ôÇÔ∏è~!üßò‚Äç‚ôÇÔ∏è Î∞∞Îã¨Ïù¥ ÏãúÏûëÎê©ÎãàÎã§.üõ•üöÅ", preferredStyle: UIAlertController.Style.alert)
    alert.addAction(UIAlertAction(title: "ÌôïÏù∏", style: UIAlertAction.Style.default, handler: { action in
      
      self.dismiss(animated: true)
    }))
    self.present(alert, animated: true, completion: nil)
  }
}


//MARK:-UITableViewDataSource
extension OderVC : UITableViewDataSource{
  func numberOfSections(in tableView: UITableView) -> Int {
    return 6
  }
  
  func tableView(_ tableView: UITableView, numberOfRowsInSection section: Int) -> Int {
    switch section {
    case 0:  //Î°úÍ∑∏Ïù∏ Ïú†Î¨¥
      return 1
    case 1://Ï£ºÎ¨∏ÏûêÏ†ïÎ≥¥
      if open == false {
        return 2
      }else {
        return 2 + 1
      }
    case 2: //Í≤∞Ï†úÏàòÎã® ÏÑ†ÌÉù
      return 1
    case 3: //Ìï†Ïù∏Î∞©Î≤ï ÏÑ†ÌÉù
      return 1
    case 4: //Î∞∞Îã¨Ï£ºÎ¨∏ ÎÇ¥Ïó≠
      return 1
    default:
      return 1
    }
  }
  
  func tableView(_ tableView: UITableView, cellForRowAt indexPath: IndexPath) -> UITableViewCell {
    switch indexPath.section {
    case 0:
      let loginCell = tableView.dequeueReusableCell(withIdentifier: "loginCell", for: indexPath) as! loginCell
      return loginCell
    case 1:
      switch indexPath.row {
      case 0:
        let InformationCell = tableView.dequeueReusableCell(withIdentifier: "InformationCell", for: indexPath) as! InformationCell
        return InformationCell
      case 1:
        let CustomOderCell = tableView.dequeueReusableCell(withIdentifier: "CustomOrderCell", for: indexPath) as! CustomOrderCell
        _ = false
        CustomOderCell.configure(title: "\(userString)")
        // print(userString)
        return CustomOderCell
        
      default:
        let unMembershipCell = tableView.dequeueReusableCell(withIdentifier: "unMembershipCell", for: indexPath) as!
          unMembershipCell
        return unMembershipCell
      }
    case 2:
      let PaywithCell = tableView.dequeueReusableCell(withIdentifier: "PaywithCell", for: indexPath) as! PaywithCell
      return PaywithCell
    case 3:
      let MembershipCell = tableView.dequeueReusableCell(withIdentifier: "MembershipCell", for: indexPath) as! MembershipCell
      return MembershipCell
    case 4:
      let OrderListCell = tableView.dequeueReusableCell(withIdentifier: "OrderListCell", for: indexPath) as! OrderListCell
      print("Ïò§ÎçîÎ¶¨Ïä§Ìä∏ÏÖÄ Ï†úÎ∞ú ÏïåÎ†§Ï£ºÏÑ∏Ïöî", indexPath)
      OrderListCell.orderData = orderList
      
      return OrderListCell
    case 5 :
      let paymentCell = tableView.dequeueReusableCell(withIdentifier: "paymentCell", for: indexPath) as! paymentCell
      return paymentCell
    default:
      let loginCell = tableView.dequeueReusableCell(withIdentifier: "loginCell", for: indexPath) as! loginCell
      return loginCell
    }
  }
}
//MARK:-UITableViewDelegate
extension OderVC : UITableViewDelegate {
  func tableView(_ tableView: UITableView, didSelectRowAt indexPath: IndexPath) {
    tableView.cellForRow(at: indexPath)
    guard let cell = tableView.cellForRow(at: indexPath) as? CustomOrderCell else {return}
    guard let index = tableView.indexPath(for: cell) else { return }
    
    
    //MARK:- pikerView
    if indexPath.section == 1 && indexPath.row == 1 {
      pikerView.frame = CGRect.init(x: 0.0, y: UIScreen.main.bounds.size.height - 300, width: UIScreen.main.bounds.size.width, height: 300)
      pikerView.backgroundColor = .white
      self.view.addSubview(pikerView)
      
      toolBar = UIToolbar.init(frame: CGRect.init(x: 0.0, y: UIScreen.main.bounds.size.height - 300, width: UIScreen.main.bounds.size.width, height: 50))
      toolBar.barStyle = .default
      toolBar.items = [UIBarButtonItem.init(title: "Done", style: .done, target: self, action: #selector(onDoneButtonTapped))]
      self.view.addSubview(toolBar)
      
    }
    
  }
  
  @objc func onDoneButtonTapped() {
    //  pikerView.reloadAllComponents()
    toolBar.removeFromSuperview()
    pikerView.removeFromSuperview()
    
  }
  
  //Ìó§Îçî
  func tableView(_ tableView: UITableView, titleForFooterInSection section: Int) -> String? {
    section == 0 ? " " : " "
  }
  
  //Ìë∏ÌÑ∞Î∑∞ ÎÜíÏù¥
  func tableView(_ tableView: UITableView, heightForFooterInSection section: Int) -> CGFloat {
    switch section{
    case 0:
      return 1
    case 1:
      return 10
    case 2:
      return 0
    case 3:
      return 10
    case 4:
      return 0
    default:
      return 0
    }
    
  }
}


extension OderVC : UISceneDelegate {
  func scrollViewDidScroll(_ scrollView: UIScrollView) {
    if scrollView.contentOffset.y > 800 {
      scrollView.contentOffset.y = 840
      paymentButton.isHidden = false
    }else{
      paymentButton.isHidden = true
    }
  }
}

